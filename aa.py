import matplotlib.pyplot as plt
import tensorflow as tf
import numpy as np
import os
import cv2
from PIL import Image, ImageDraw
import random
import torch
from torch.autograd import Variable
from torchvision import models, transforms


# 用于装载和使用初始模型的函数和类。
import inception
# inception.data_dir = 'inception/'
model = inception.Inception()
resized_image = model.resized_image
y_pred = model.y_pred
y_logits = model.y_logits

# 将初始模型的图设置为默认图，
# 所以这个with_block中的所有变化都被画出来了。
# with model.graph.as_default():

#     #为目标类编号添加一个占位符变量。
#     pl_cls_target = tf.compat.v1.placeholder(dtype=tf.int32)
#     #添加一个新的损失函数。
#     loss = tf.nn.sparse_softmax_cross_entropy_with_logits(logits=y_logits, labels=[pl_cls_target])

#     #获取关于损失函数的梯度。
#     #调整输入图像的大小。
#     gradient = tf.gradients(loss, resized_image)

session = tf.compat.v1.Session(graph=model.graph)

classes = ['490',
           '361',
           '171',
           '822',
           '297',
           '482',
           '13',
           '704',
           '599',
           '164',
           '649',
           '11',
           '73',
           '286',
           '554',
           '6',
           '648',
           '399',
           '749',
           '545',
           '13',
           '204',
           '318',
           '693',
           '399',
           '304',
           '102',
           '207',
           '480',
           '780',
           '644',
           '275',
           '14',
           '954',
           '249',
           '790',
           '501',
           '547',
           '809',
           '606',
           '297',
           '927',
           '424',
           '156',
           '60',
           '983',
           '256',
           '207',
           '281',
           '456',
           '413',
           '498',
           '561',
           '750',
           '182',
           '267',
           '118',
           '893',
           '597',
           '840',
           '836',
           '107',
           '647',
           '471',
           '945',
           '451',
           '214',
           '790',
           '291',
           '837',
           '707',
           '193',
           '397',
           '568',
           '401',
           '705',
           '200',
           '202',
           '31',
           '949',
           '361',
           '98',
           '709',
           '483',
           '563',
           '695',
           '122',
           '497',
           '914',
           '476',
           '102',
           '199',
           '104',
           '221',
           '138',
           '257',
           '188',
           '436',
           '229',
           '52',
           '377',
           '200',
           '597',
           '544',
           '131',
           '935',
           '602',
           '342',
           '508',
           '748',
           '617',
           '901',
           '184',
           '513',
           '204',
           '999',
           '782',
           '922',
           '869',
           '598',
           '596',
           '701',
           '970',
           '452',
           '631',
           '817',
           '57',
           '398',
           '885',
           '10',
           '288',
           '305',
           '34',
           '112',
           '273',
           '120',
           '959',
           '657',
           '823',
           '356',
           '32',
           '657',
           '753',
           '372',
           '364',
           '349',
           '106',
           '513',
           '551',
           '366',
           '228',
           '917',
           '464',
           '655',
           '737',
           '58',
           '62',
           '219',
           '832',
           '922',
           '192',
           '303',
           '946',
           '996',
           '737',
           '333',
           '729',
           '824',
           '517',
           '89',
           '724',
           '2',
           '829',
           '172',
           '266',
           '123',
           '434',
           '149',
           '39',
           '171',
           '44',
           '662',
           '734',
           '782',
           '270',
           '153',
           '283',
           '58',
           '217',
           '581',
           '170',
           '306',
           '689',
           '753',
           '613',
           '454',
           '885',
           '392',
           '316',
           '956',
           '527',
           '817',
           '47',
           '223',
           '516',
           '100',
           '441',
           '659',
           '803',
           '297',
           '95',
           '343',
           '576',
           '367',
           '576',
           '330',
           '392',
           '609',
           '961',
           '143',
           '818',
           '764',
           '377',
           '192',
           '494',
           '820',
           '150',
           '204',
           '460',
           '769',
           '620',
           '800',
           '153',
           '683',
           '365',
           '450',
           '207',
           '616',
           '985',
           '994',
           '315',
           '104',
           '595',
           '541',
           '620',
           '52',
           '389',
           '45',
           '756',
           '303',
           '328',
           '901',
           '991',
           '290',
           '982',
           '821',
           '914',
           '496',
           '984',
           '976',
           '711',
           '450',
           '66',
           '564',
           '584',
           '549',
           '844',
           '540',
           '3',
           '361',
           '680',
           '718',
           '44',
           '861',
           '578',
           '496',
           '588',
           '413',
           '27',
           '669',
           '294',
           '961',
           '10',
           '334',
           '935',
           '819',
           '518',
           '235',
           '246',
           '528',
           '825',
           '381',
           '449',
           '289',
           '684',
           '682',
           '468',
           '489',
           '601',
           '66',
           '658',
           '673',
           '76',
           '886',
           '750',
           '162',
           '450',
           '592',
           '885',
           '379',
           '955',
           '447',
           '360',
           '920',
           '341',
           '451',
           '994',
           '400',
           '215',
           '229',
           '543',
           '44',
           '67',
           '490',
           '809',
           '40',
           '42',
           '397',
           '383',
           '720',
           '668',
           '738',
           '143',
           '923',
           '843',
           '820',
           '485',
           '790',
           '529',
           '37',
           '848',
           '626',
           '186',
           '761',
           '593',
           '301',
           '239',
           '206',
           '775',
           '113',
           '912',
           '576',
           '890',
           '296',
           '168',
           '425',
           '270',
           '719',
           '988',
           '504',
           '621',
           '462',
           '428',
           '917',
           '284',
           '833',
           '573',
           '769',
           '231',
           '412',
           '649',
           '703',
           '564',
           '346',
           '176',
           '827',
           '559',
           '999',
           '91',
           '794',
           '220',
           '717',
           '97',
           '374',
           '973',
           '647',
           '696',
           '341',
           '429',
           '428',
           '88',
           '539',
           '171',
           '368',
           '606',
           '608',
           '970',
           '199',
           '151',
           '967',
           '40',
           '241',
           '243',
           '458',
           '21',
           '734',
           '224',
           '329',
           '102',
           '696',
           '109',
           '329',
           '574',
           '390',
           '418',
           '555',
           '547',
           '639',
           '879',
           '413',
           '310',
           '752',
           '735',
           '98',
           '106',
           '782',
           '814',
           '841',
           '107',
           '599',
           '267',
           '267',
           '969',
           '284',
           '818',
           '123',
           '723',
           '888',
           '392',
           '109',
           '31',
           '938',
           '744',
           '9',
           '995',
           '44',
           '44',
           '344',
           '312',
           '172',
           '659',
           '285',
           '997',
           '572',
           '709',
           '162',
           '87',
           '566',
           '847',
           '714',
           '740',
           '99',
           '743',
           '675',
           '783',
           '421',
           '346',
           '542',
           '541',
           '435',
           '464',
           '956',
           '570',
           '72',
           '682',
           '394',
           '581',
           '147',
           '349',
           '40',
           '169',
           '317',
           '733',
           '331',
           '545',
           '137',
           '11',
           '764',
           '789',
           '714',
           '830',
           '441',
           '966',
           '767',
           '100',
           '6',
           '502',
           '495',
           '547',
           '31',
           '102',
           '53',
           '315',
           '834',
           '592',
           '301',
           '141',
           '507',
           '848',
           '625',
           '18',
           '481',
           '766',
           '839',
           '542',
           '671',
           '62',
           '74',
           '661',
           '175',
           '351',
           '692',
           '464',
           '191',
           '700',
           '766',
           '747',
           '401',
           '982',
           '205',
           '114',
           '695',
           '68',
           '670',
           '957',
           '168',
           '382',
           '906',
           '196',
           '915',
           '473',
           '799',
           '864',
           '263',
           '22',
           '654',
           '420',
           '437',
           '506',
           '776',
           '358',
           '162',
           '96',
           '739',
           '349',
           '238',
           '929',
           '580',
           '234',
           '257',
           '710',
           '887',
           '729',
           '370',
           '101',
           '827',
           '780',
           '590',
           '733',
           '387',
           '238',
           '900',
           '882',
           '974',
           '562',
           '407',
           '428',
           '193',
           '711',
           '548',
           '645',
           '370',
           '794',
           '718',
           '74',
           '795',
           '904',
           '126',
           '373',
           '179',
           '694',
           '163',
           '424',
           '115',
           '247',
           '539',
           '194',
           '819',
           '132',
           '85',
           '252',
           '786',
           '184',
           '155',
           '323',
           '900',
           '963',
           '781',
           '6',
           '30',
           '289',
           '145',
           '198',
           '355',
           '938',
           '329',
           '157',
           '645',
           '955',
           '793',
           '542',
           '809',
           '247',
           '808',
           '622',
           '722',
           '978',
           '215',
           '950',
           '999',
           '230',
           '331',
           '704',
           '779',
           '130',
           '562',
           '545',
           '392',
           '640',
           '508',
           '757',
           '101',
           '94',
           '129',
           '372',
           '999',
           '980',
           '429',
           '585',
           '85',
           '386',
           '596',
           '970',
           '777',
           '216',
           '783',
           '169',
           '148',
           '269',
           '228',
           '147',
           '227',
           '252',
           '244',
           '5',
           '544',
           '219',
           '139',
           '612',
           '686',
           '282',
           '128',
           '355',
           '742',
           '183',
           '923',
           '552',
           '376',
           '610',
           '691',
           '352',
           '572',
           '471',
           '892',
           '188',
           '773',
           '905',
           '487',
           '656',
           '422',
           '324',
           '627',
           '683',
           '72',
           '73',
           '59',
           '992',
           '667',
           '455',
           '251',
           '828',
           '596',
           '656',
           '574',
           '893',
           '967',
           '541',
           '154',
           '8',
           '338',
           '320',
           '666',
           '389',
           '287',
           '687',
           '94',
           '277',
           '670',
           '46',
           '267',
           '907',
           '964',
           '48',
           '689',
           '27',
           '16',
           '318',
           '813',
           '15',
           '865',
           '913',
           '567',
           '10',
           '748',
           '424',
           '342',
           '664',
           '695',
           '397',
           '707',
           '750',
           '813',
           '919',
           '418',
           '958',
           '249',
           '386',
           '26',
           '492',
           '797',
           '435',
           '293',
           '693',
           '214',
           '878',
           '1',
           '830',
           '115',
           '307',
           '697',
           '821',
           '705',
           '940',
           '279',
           '857',
           '910',
           '278',
           '621',
           '808',
           '571',
           '845',
           '635',
           '948',
           '424',
           '447',
           '802',
           '313',
           '681',
           '35',
           '911',
           '652',
           '953',
           '508',
           '283',
           '155',
           '486',
           '905',
           '96',
           '813',
           '540',
           '459',
           '952',
           '920',
           '427',
           '882',
           '55',
           '665',
           '325',
           '131',
           '151',
           '823',
           '158',
           '511',
           '307',
           '831',
           '482',
           '496',
           '872',
           '700',
           '642',
           '885',
           '686',
           '705',
           '333',
           '535',
           '816',
           '598',
           '615',
           '627',
           '873',
           '616',
           '564',
           '865',
           '146',
           '431',
           '675',
           '552',
           '37',
           '249',
           '553',
           '749',
           '210',
           '882',
           '926',
           '551',
           '651',
           '395',
           '161',
           '714',
           '381',
           '595',
           '340',
           '593',
           '352',
           '802',
           '511',
           '47',
           '797',
           '687',
           '755',
           '896',
           '725',
           '277',
           '899',
           '988',
           '895',
           '557',
           '819',
           '852',
           '402',
           '572',
           '554',
           '734',
           '691',
           '163',
           '928',
           '49',
           '244',
           '331',
           '96',
           '61',
           '693',
           '388',
           '765',
           '145',
           '505',
           '602',
           '424',
           '706',
           '393',
           '745',
           '158',
           '119',
           '32',
           '401',
           '740',
           '375',
           '397',
           '156',
           '494',
           '975',
           '39',
           '548',
           '541',
           '874',
           '706',
           '577',
           '201',
           '766',
           '770',
           '237',
           '750',
           '932',
           '543',
           '563',
           '805',
           '116',
           '466',
           '32',
           '659',
           '383',
           '205',
           '236',
           '780',
           '698',
           '399',
           '533',
           '455',
           '554',
           '571',
           '445',
           '145',
           '854',
           '626',
           '471',
           '624',
           '511',
           '793',
           '412',
           '459',
           '286',
           '677',
           '451',
           '608',
           '545',
           '986',
           '188',
           '459',
           '425',
           '217',
           '481',
           '512',
           '610',
           '500',
           '137',
           '211',
           '297',
           '200',
           '59',
           '873',
           '682',
           '417',
           '254',
           '886',
           '597',
           '623',
           '348',
           '458',
           '593',
           '564',
           '677',
           '396',
           '394',
           '135',
           '640',
           '245',
           '893',
           '381',
           '560',
           '213',
           '544',
           '631',
           '874',
           '96',
           '140',
           '270',
           '744',
           '468',
           '752',
           '774',
           '164',
           '836',
           '34',
           '867',
           '930',
           '609',
           '781',
           '919',
           '329',
           '657',
           '565',
           '161',
           '3',
           '450',
           '932',
           '452',
           '50',
           '264',
           '536',
           '301',
           '160',
           '990',
           '53',
           '590',
           '79',
           '945',
           '603',
           '594',
           '143',
           '496',
           '522',
           '254',
           '785',
           '644',
           '642',
           '870',
           '227',
           '712',
           '930',
           '278',
           '700',
           '469',
           '931',
           '392',
           '75',
           '657',
           '81',
           '27',
           '595',
           '350',
           '385',
           '135',
           '494',
           '248',
           '854',
           '216',
           '604',
           '68',
           '46',
           '10',
           '891',
           '478',
           '833',
           '421',
           '1000',
           '428',
           '200',
           '849',
           '173',
           '186',
           '452',
           '337',
           '604',
           '199',
           '304',
           '440',
           '649',
           '327',
           '998',
           '206',
           '845',
           '596',
           '241',
           '798',
           '118',
           '167',
           '426',
           '423',
           '69',
           '134',
           '543',
           '985',
           '432',
           '47',
           '100',
           '901',
           '580',
           '953',
           '889',
           '779',
           '560',
           '634',
           '956',
           '393',
           '965',
           '569',
           '888',
           '129',
           '543',
           '353',
           '521',
           '73',
           '267',
           '721',
           '54',
           '197',
           '180',
           '907',
           '175',
           '544',
           '10',
           '810',
           '933',
           '37',
           '338',
           '244',
           '573',
           '484',
           '93',
           '375',
           '245',
           '125',
           '97',
           '384',
           '806',
           '276',
           '327',
           '343',
           '808',
           '332',
           '435',
           '615',
           '125',
           '616',
           '745',
           '820',
           '559',
           '207',
           '60',
           '358',
           '497',
           '10',
           '794',
           '901',
           '845',
           '401',
           '204',
           '498',
           '659',
           '818',
           '198',
           '412',
           '285',
           '280',
           '716',
           '405',
           '171',
           '136',
           '843',
           '607',
           '900',
           '168',
           '367',
           '997',
           '137',
           '281',
           '541',
           '417',
           '816',
           '308',
           '225',
           '434',
           '409',
           '198',
           '431',
           '945',
           '919',
           '762',
           '753',
           '875',
           '241',
           '205',
           '800',
           '516',
           '984',
           '453',
           '24',
           '920',
           '431',
           '926',
           '935',
           '245',
           '530',
           '297',
           '489',
           '786',
           '641',
           '963',
           '452',
           '708',
           '125',
           '880',
           '455',
           '229',
           '160',
           '957',
           '976',
           '118',
           '61',
           '252',
           '268',
           '891',
           '133',
           '237',
           '729',
           '21',
           '920',
           '815',
           '915',
           '519',
           '957',
           '155',
           '400',
           '820',
           '641',
           '548',
           '129',
           '397',
           '919',
           '890',
           '341',
           '45',
           '94',
           '2',
           '99',
           '157',
           '922',
           '99',
           '532',
           '423',
           '956',
           '65',
           '974',
           '49',
           '957',
           '135',
           '53',
           '639',
           '559',
           '775',
           '13',
           '708',
           '254',
           '116',
           '502',
           '550',
           '274',
           '162',
           '978',
           '204',
           '991',
           '941',
           '534',
           '203',
           '316',
           '796',
           '814',
           '845',
           '940',
           '1',
           '926',
           '867',
           '758',
           '564',
           '842',
           '963',
           '181',
           '653',
           '510',
           '368',
           '6',
           '601',
           '346',
           '387',
           '1000',
           '867',
           '422',
           '540',
           '52',
           '108',
           '803',
           '241',
           '610',
           '158',
           '853',
           '91',
           '1000',
           '410',
           '307',
           '643',
           '541',
           '361',
           '287',
           '598',
           '799',
           '822',
           '113',
           '857',
           '836',
           '714',
           '263',
           '114',
           '781',
           '367',
           '154',
           '561',
           '281',
           '844',
           '482',
           '815',
           '254',
           '516',
           '82',
           '3',
           '873',
           '259',
           '223',
           '302',
           '952',
           '367',
           '349',
           '917',
           '366',
           '249',
           '678',
           '239',
           '367',
           '672',
           '215',
           '544',
           '379',
           '547',
           '186',
           '781',
           '159',
           '413',
           '856',
           '476',
           '243',
           '310',
           '174',
           '291',
           '939',
           '84',
           '862',
           '863',
           '805',
           '938',
           '148',
           '712',
           '698',
           '153',
           '516',
           '538',
           '689',
           '226',
           '418',
           '214',
           '190',
           '162',
           '822',
           '981',
           '181',
           '906',
           '575',
           '612',
           '350',
           '384',
           '353',
           '604',
           '89',
           '816',
           '764',
           '735',
           '472',
           '932',
           '905',
           '813',
           '88',
           '520',
           '619',
           '290',
           '689',
           '909',
           '25',
           '48',
           '423',
           '804',
           '43',
           '230',
           '399',
           '743',
           '116',
           '927',
           '943',
           '553',
           '143',
           '385',
           '539',
           '337',
           '133',
           '666',
           '920',
           '148',
           '768',
           '319',
           '212',
           '17',
           '597',
           '848',
           '898',
           '528',
           '919',
           '196',
           '974',
           '345',
           '815',
           '802',
           '45',
           '977',
           '623',
           '997',
           '521',
           '759',
           '25',
           '713',
           '723',
           '995',
           '534',
           '963',
           '223',
           '567',
           '374',
           '144',
           '410',
           '456',
           '890',
           '270',
           '157',
           '942',
           '984',
           '38',
           '252',
           '359',
           '109',
           '374',
           '590',
           '106',
           '613',
           '257',
           '256',
           '898',
           '338',
           '607',
           '286',
           '551',
           '862',
           '203',
           '358',
           '608',
           '404',
           '390',
           '735',
           '354',
           '760',
           '638',
           '46',
           '807',
           '205',
           '514',
           '761',
           '14',
           '167',
           '780',
           '470',
           '999',
           '990',
           '157',
           '322',
           '407',
           '56',
           '487',
           '953',
           '141',
           '25',
           '25',
           '136',
           '397',
           '796',
           '6',
           '279',
           '348',
           '606',
           '50',
           '853',
           '8',
           '876',
           '103',
           '225',
           ]


def pr(image_path):
    # 用图像创建一个封条。
    feed_dict = model._create_feed_dict(image_path=image_path)

    # 使用TensorFlow计算预测的类得分。
    pred, image = session.run([y_pred, resized_image],
                              feed_dict=feed_dict)

    # 转换为一维数组。
    pred = np.squeeze(pred)

    # 预测类数。
    cls_source = np.argmax(pred)

    return cls_source
    # print("score:",cls_source)



qb=[0.001,0.005,0.01,0.015,0.02,0.025]
for q in qb:
    sum = 40
    true_lsit = []
    count1 = 0
    count2 = 0
    for i in range(sum):
        # 读取图像
        img= 'AE/' + str(i) + '_.png'
        #img = Image.open(img).convert('RGB')
        # img = cv2.imread(path)

        score = pr(img)
        if score == int(classes[i]):
        # print("***************************")
            # print(i)
            #print("预测成功")
            true_lsit.append(i)

        else:
        #         #img = cv2.cvtColor(np.asarray(img), cv2.COLOR_RGB2BGR)
                img = Image.open(img)
                img = np.asarray(img)
                
                def sp_noise(image,prob):
                    '''
                    添加椒盐噪声
                    prob:噪声比例
                    '''
                    output = np.zeros(image.shape,np.uint8)
                    thres = 1 - prob
                    for i in range(image.shape[0]):
                        for j in range(image.shape[1]):
                            rdn = random.random()
                            if rdn < prob:
                                output[i][j] = 0
                            elif rdn > thres:
                                output[i][j] = 255
                            else:
                                output[i][j] = image[i][j]
                    return output
                def gasuss_noise(image, mean=0, var=0.001):
                    '''
                        添加高斯噪声
                        mean : 均值
                        var : 方差
                    '''
                    image = np.array(image/255, dtype=float)
                    noise = np.random.normal(mean, var ** 0.5, image.shape)
                    out = image + noise
                    if out.min() < 0:
                        low_clip = -1.
                    else:
                        low_clip = 0.
                    out = np.clip(out, low_clip, 1.0)
                    out = np.uint8(out*255)
                    # cv.imshow("gasuss", out)
                    return out
                # Read image
                # img = cv2.imread("../paojie.jpg")
                # 添加椒盐噪声，噪声比例为 0.02
                out1 = sp_noise(img, prob=q)
                img1 = cv2.cvtColor(out1, cv2.COLOR_RGB2BGR)
                path1= 'images/tt/' + str(i) + '_JY.png'
                cv2.imwrite(path1,img1, [int(cv2.IMWRITE_PNG_COMPRESSION), 0])
                # 添加高斯噪声，均值为0，方差为0.001
                out2 = gasuss_noise(img, mean=0, var=q)
                img2 = cv2.cvtColor(out2, cv2.COLOR_RGB2BGR)
                path2= 'images/tt/' + str(i) + '_GS.png'
                cv2.imwrite(path2,img2, [int(cv2.IMWRITE_PNG_COMPRESSION), 0])
                # 显示图像
                plt.figure(1)
                plt.subplot(131)
                plt.axis('off')  # 关闭坐标轴
                plt.title('Original')
                plt.imshow(img)
                plt.subplot(132)
                plt.axis('off')
                plt.title('Add Salt and Pepper noise')
                plt.imshow(out1)
                plt.subplot(133)
                plt.axis('off')
                plt.title('Add Gaussian noise')
                plt.imshow(out2)
                plt.show()

                # 再预测
                # path1= 'images/tt/' + str(i) + '_JY.png'
                path2= 'images/tt/' + str(i) + '_GS.png'
                # score1 = pr(path1)
                score2 = pr(path2)
                # if score1 ==int(classes[i]):
                    # count1 = count1 + 1
                    # print("***************************")
                    # print("变换后预测正确")
                    # print(np.argmax(predict))
                if score2 ==int(classes[i]):
                   count2 = count2 + 1

                # else:
                #     print("变换后后预测失败")

        #     # else:
        #     #     print("***************************")
        #     #     print(i)
                # print("预测失败")
    #print("预测成功率:", (len(true_lsit)/sum))
    # print('变换之前对抗样本数量:', (sum-len(true_lsit)))  # 这是第一次预测失败的样本总数
    # print('加了椒盐噪声之后预测成功的样本数量:', count1)#这是变换之后预测成功的样本数量
    # print('加了椒盐噪声之后防御成功率：', count1/(sum-len(true_lsit)))
    # print('加了高斯噪声之后预测成功的样本数量:', count2)#这是变换之后预测成功的样本数量
    print(count2/(sum-len(true_lsit)))
